@page "/"
@using MhFrontend.Models
@using MhFrontend.Services

<PageTitle>Numen - Математический ИИ</PageTitle>

<div class="main-container">
    <h1 class="brand-header">Numen</h1>

    <div class="chat-history">
        @if (!string.IsNullOrEmpty(UserMessageFace))
        {
            <div class="message user-message">
                @UserMessageFace
            </div>
        }

        @if (!string.IsNullOrEmpty(AiMessageFace))
        {
            <div class="message ai-message">
                <strong>Numen:</strong><br />
                @AiMessageFace
            </div>
        }
    </div>

    <div class="input-area">
        <input @bind="UserMessageFace" 
               @bind:event="oninput"
               placeholder="Введите математическую задачу..." 
               @onkeyup="HandleKeyUp" />
        <button class="send-btn" @onclick="AskButton_OnClick">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
            </svg>
        </button>
    </div>
</div>

@code {
    private string UserMessageFace { get; set; } = ""; 
    private string AiMessageFace { get; set; } = ""; 
    private bool _isProcessing = false;

    private readonly IApiService _srv = new ApiService(new Logger<IApiService>(new LoggerFactory())); 

    private async Task AskButton_OnClick() 
    {
        if (string.IsNullOrWhiteSpace(UserMessageFace) || _isProcessing) return;

        _isProcessing = true;
        try
        {
            var input = new UserMessage(Guid.NewGuid(), UserMessageFace); 
            var result = await _srv.askBackend(input); 
            AiMessageFace = result?.content ?? "Ошибка при запросе"; 
        }
        catch (Exception e)
        {
            AiMessageFace = $"Ошибка при запросе: {e.Message}"; 
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private async Task HandleKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await AskButton_OnClick();
        }
    }
}